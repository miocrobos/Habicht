generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PLAYER
  RECRUITER
  HYBRID
  ADMIN
  CLUB_MANAGER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Position {
  OUTSIDE_HITTER    // Aussenspieler
  OPPOSITE          // Diagonalspieler
  MIDDLE_BLOCKER    // Mittelblocker
  SETTER            // Zuspieler/Passeur
  LIBERO            // Libero
  UNIVERSAL         // Universal
}

enum League {
  NLA              // Nationalliga A
  NLB              // Nationalliga B
  FIRST_LEAGUE     // 1. Liga
  SECOND_LEAGUE    // 2. Liga
  THIRD_LEAGUE     // 3. Liga
  FOURTH_LEAGUE    // 4. Liga
  FIFTH_LEAGUE     // 5. Liga
  YOUTH_U23        // U23
  YOUTH_U19        // U19
  YOUTH_U17        // U17
  YOUTH_U15        // U15
  HIGH_SCHOOL      // Kantonsschule
}

enum Canton {
  ZH  // Zürich
  BE  // Bern
  LU  // Luzern
  UR  // Uri
  SZ  // Schwyz
  OW  // Obwalden
  NW  // Nidwalden
  GL  // Glarus
  ZG  // Zug
  FR  // Fribourg
  SO  // Solothurn
  BS  // Basel-Stadt
  BL  // Basel-Landschaft
  SH  // Schaffhausen
  AR  // Appenzell Ausserrhoden
  AI  // Appenzell Innerrhoden
  SG  // St. Gallen
  GR  // Graubünden
  AG  // Aargau
  TG  // Thurgau
  TI  // Ticino
  VD  // Vaud
  VS  // Valais
  NE  // Neuchâtel
  GE  // Genève
  JU  // Jura
}

enum SchoolType {
  GYMNASIUM       // Kantonsschule/Gymnasium
  BERUFSSCHULE    // Berufsschule/Vocational School
  FH              // Fachhochschule/University of Applied Sciences
  UNIVERSITY      // Universität/University
  OTHER           // Other education
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum ChatRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum NotificationType {
  PROFILE_VIEW
  MESSAGE
  CHAT_REQUEST
  CLUB_INTEREST
  RECRUITER_INTEREST
  PROFILE_UPDATE
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(PLAYER)
  emailVerified Boolean   @default(false)
  verificationToken String?  @unique
  verificationTokenExpiry DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Notification Preferences
  notifyChatMessages Boolean @default(true)
  notifyPlayerLooking Boolean @default(true)
  notifyRecruiterSearching Boolean @default(true)
  
  player        Player?
  recruiter     Recruiter?
  clubManager   ClubManager?
  passwordResetRequests PasswordResetRequest[]
  viewedProfiles PlayerView[] @relation("ViewerViews")
  notifications Notification[] @relation("UserNotifications")
  sentNotifications Notification[] @relation("NotificationSender")
  watchlist     Watchlist[] @relation("WatchlistWatchers")
}

model Player {
  id                String      @id @default(cuid())
  userId            String      @unique
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Information
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  gender            Gender
  height            Float?      // in cm
  weight            Float?      // in kg
  spikeHeight       Float?      // spike reach in cm
  blockHeight       Float?      // block reach in cm
  blockReach        Float?      // in cm (legacy field)
  spikeReach        Float?      // in cm (legacy field)
  nationality       String      @default("Swiss")
  canton            Canton      // Canton of residence
  city              String
  municipality      String?     // Municipality/Gemeinde within canton
  
  // Employment/Education Status
  employmentStatus  String?     // STUDENT_FULL_TIME, STUDENT_PART_TIME, WORKING_FULL_TIME, WORKING_PART_TIME
  occupation        String?     // Job title if working
  
  // Volleyball Information
  positions         Position[]  @default([]) // Multiple positions player can play
  jerseyNumber      Int?
  hasClub           Boolean     @default(false) // Whether player is currently in a club
  clubName          String?     // Name of current club (if not in our database)
  currentClubId     String?
  currentClub       Club?       @relation("CurrentClub", fields: [currentClubId], references: [id])
  currentLeague     League?     // Current league - only set if player has current club
  desiredLeague     League?     // Target league level player wants to play in
  interestedClubs   String[]    @default([]) // Array of club IDs player is interested in
  
  // Skills Self-Assessment (1-5 stars)
  skillReceiving    Int?        @default(0)
  skillServing      Int?        @default(0)
  skillAttacking    Int?        @default(0)
  skillBlocking     Int?        @default(0)
  skillDefense      Int?        @default(0)
  
  // Academic Information
  schoolName        String?     // Name of school/university
  schoolType        SchoolType? // Type of educational institution
  graduationYear    Int?
  isStudent         Boolean     @default(false) // Whether currently a student
  
  // Contact & Social Media
  phone             String?
  instagram         String?     // Instagram handle
  instagramHandle   String?     // Legacy field
  tiktok            String?     // TikTok handle
  tiktokHandle      String?     // Legacy field
  youtube           String?     // YouTube channel
  youtubeChannel    String?     // Legacy field
  
  // Media & Documents
  highlightVideo    String?     // Base64 or URL to highlight video
  swissVolleyLicense String?    // Swiss Volley license photo
  ausweiss          String?     // Swiss ID/permit photo
  
  // Profile
  bio               String?     @db.Text
  profileImage      String      // Required profile picture
  coverImage        String?     // Optional backdrop/banner image
  backgroundGradient String?     // Selected background gradient ID (e.g., 'gradient1', 'solid-red')
  achievements      String[]    @default([])        // Notable achievements list
  
  // Visibility & Status
  isPublic          Boolean     @default(true)
  lookingForOffers  Boolean     @default(true)
  isActive          Boolean     @default(true)      // Currently active player
  lookingForClub    Boolean     @default(false)     // Actively seeking new club
  isPlaceholder     Boolean     @default(false)     // Imported from Volleybox, can be claimed/removed
  
  // Privacy Settings
  showEmail         Boolean     @default(false)     // Show email publicly
  showPhone         Boolean     @default(false)     // Show phone publicly
  
  // Stats
  views             Int         @default(0)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  stats             PlayerStats[]
  videos            Video[]
  clubHistory       ClubHistory[]
  achievementRecords Achievement[]
  recruitmentNotes  RecruitmentNote[]
  favorites         Favorite[]
  teammates         Teammate[]  @relation("PlayerTeammates")
  teamOf            Teammate[]  @relation("TeammatePlayer")
  chatRequests      ChatRequest[]
  conversations     Conversation[]
  sentMessages      Message[]   @relation("PlayerMessages")
  profileViews      PlayerView[] @relation("ProfileViews")
  watchedBy         Watchlist[] @relation("WatchedPlayers")
  photos            PlayerPhoto[]
}

model PlayerPhoto {
  id          String   @id @default(cuid())
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  photoUrl    String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  
  @@index([playerId])
  @@index([playerId, order])
}

model Club {
  id                String      @id @default(cuid())
  name              String      @unique
  shortName         String?
  logo              String?
  website           String?
  swissVolleyId     String?     @unique
  
  // Location
  canton            Canton
  town              String
  municipality      String?     // Gemeinde/Municipality within canton
  
  // Contact
  email             String?
  phone             String?
  
  // Social Media
  facebook          String?     // Facebook page URL
  instagram         String?     // Instagram handle
  tiktok            String?     // TikTok handle
  twitter           String?     // Twitter/X handle
  youtube           String?     // YouTube channel URL
  
  // Info
  founded           Int?        // founding year
  description       String?     @db.Text
  colors            String[]
  achievements      String[]    @default([]) // Club achievements and titles
  
  // League teams - boolean flags for which leagues/genders this club has teams in
  hasNLAMen         Boolean     @default(false)
  hasNLAWomen       Boolean     @default(false)
  hasNLBMen         Boolean     @default(false)
  hasNLBWomen       Boolean     @default(false)
  has1LigaMen       Boolean     @default(false)
  has1LigaWomen     Boolean     @default(false)
  has2LigaMen       Boolean     @default(false)
  has2LigaWomen     Boolean     @default(false)
  has3LigaMen       Boolean     @default(false)
  has3LigaWomen     Boolean     @default(false)
  has4LigaMen       Boolean     @default(false)
  has4LigaWomen     Boolean     @default(false)
  hasU23Men         Boolean     @default(false)
  hasU23Women       Boolean     @default(false)
  hasU19Men         Boolean     @default(false)
  hasU19Women       Boolean     @default(false)
  hasU17Men         Boolean     @default(false)
  hasU17Women       Boolean     @default(false)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  currentPlayers    Player[]    @relation("CurrentClub")
  clubHistory       ClubHistory[]
  managers          ClubManager[]
  coaches           Coach[]
  recruiters        Recruiter[] @relation("RecruiterClub")
  recruiterHistory  RecruiterClubHistory[]
}

model ClubHistory {
  id                String      @id @default(cuid())
  playerId          String
  player            Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  clubId            String?     // Optional - null if club not in database
  club              Club?       @relation(fields: [clubId], references: [id])
  
  // For clubs not in database
  clubName          String?     // Manual club name entry
  clubLogo          String?     // Base64 or URL to uploaded club logo
  clubCountry       String      @default("Switzerland") // Country if club outside Switzerland
  clubWebsiteUrl    String?     // Club website URL - set once during registration, immutable
  league            String?     // League/Division name
  
  startDate         DateTime
  endDate           DateTime?
  jerseyNumber      Int?
  currentClub       Boolean     @default(false) // Is this the player's current club
  
  createdAt         DateTime    @default(now())
  
  @@index([clubId])
}

model Coach {
  id                String      @id @default(cuid())
  firstName         String
  lastName          String
  email             String?
  phone             String?
  
  // Current club
  clubId            String
  club              Club        @relation(fields: [clubId], references: [id])
  
  // Position
  role              String      // Head Coach, Assistant Coach, etc.
  specialization    String?     // Attack, Defense, Setting, etc.
  
  // Info
  bio               String?     @db.Text
  photoUrl          String?
  
  // Experience
  yearsExperience   Int?
  certifications    String[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([clubId])
}

model Teammate {
  id                String      @id @default(cuid())
  playerId          String
  player            Player      @relation("PlayerTeammates", fields: [playerId], references: [id], onDelete: Cascade)
  
  teammateId        String
  teammate          Player      @relation("TeammatePlayer", fields: [teammateId], references: [id], onDelete: Cascade)
  
  // Context
  clubName          String
  season            String      // e.g., "2023-2024"
  
  createdAt         DateTime    @default(now())
  
  @@unique([playerId, teammateId, season])
  @@index([playerId])
  @@index([teammateId])
}

model PlayerStats {
  id                String      @id @default(cuid())
  playerId          String
  player            Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  season            String      // e.g., "2023-2024"
  
  // Match stats
  matchesPlayed     Int         @default(0)
  setsPlayed        Int         @default(0)
  
  // Offensive stats
  points            Int         @default(0)
  kills             Int         @default(0)
  attackAttempts    Int         @default(0)
  attackPercentage  Float?
  
  // Serving stats
  aces              Int         @default(0)
  serviceErrors     Int         @default(0)
  
  // Defensive stats
  blocks            Int         @default(0)
  digs              Int         @default(0)
  
  // Setting stats (for setters)
  assists           Int         @default(0)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@unique([playerId, season])
  @@index([playerId])
}

model Video {
  id                String      @id @default(cuid())
  playerId          String
  player            Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  title             String
  description       String?     @db.Text
  
  // Video source
  videoType         VideoType
  videoUrl          String      // Cloudinary URL or YouTube/TikTok/Instagram URL
  thumbnailUrl      String?
  
  // Video details
  duration          Int?        // in seconds
  uploadDate        DateTime    @default(now())
  
  // Categorization
  highlightType     HighlightType
  matchDate         DateTime?
  opponent          String?
  
  views             Int         @default(0)
  isPublic          Boolean     @default(true)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([playerId])
}

enum VideoType {
  UPLOADED      // Uploaded to Cloudinary
  YOUTUBE
  INSTAGRAM
  TIKTOK
}

enum HighlightType {
  FULL_MATCH
  HIGHLIGHTS
  SKILLS
  SERVING
  ATTACKING
  BLOCKING
  DEFENSE
  SETTING
  TRAINING
}

model Achievement {
  id                String      @id @default(cuid())
  playerId          String
  player            Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  title             String
  description       String?     @db.Text
  date              DateTime
  type              AchievementType
  
  createdAt         DateTime    @default(now())
  
  @@index([playerId])
}

enum AchievementType {
  CHAMPIONSHIP
  MVP
  BEST_PLAYER
  TOURNAMENT_WIN
  NATIONAL_TEAM
  YOUTH_NATIONAL_TEAM
  ALL_STAR
  OTHER
}

model Recruiter {
  id                String      @id @default(cuid())
  userId            String      @unique
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Information
  firstName         String
  lastName          String
  age               Int
  nationality       String      @default("Swiss")
  
  // Location
  canton            Canton
  province          String?     // Municipality/Province within canton
  country           String      @default("Switzerland")
  
  // Current Club Affiliation
  clubId            String
  club              Club        @relation("RecruiterClub", fields: [clubId], references: [id])
  coachRole         String      // Head Coach, Assistant Coach, Scout, etc.
  
  // Coaching Details
  genderCoached     Gender[]    @default([]) // Which gender teams they coach (MALE/FEMALE) - can coach both
  positionsLookingFor Position[] @default([]) // Positions they're recruiting for
  
  // Licenses & Credentials (optional)
  coachingLicense   String?     // Photo/document of coaching license
  ausweiss          String?     // Swiss ID/permit photo
  
  // Professional Info
  organization      String      // Club name or Agency
  position          String      // Title/Role
  phone             String?
  bio               String?     @db.Text
  profileImage      String?     // Profile picture (optional for recruiters)
  coverImage        String?     // Optional backdrop/banner image
  achievements      String[]    @default([]) // Achievements and awards
  
  // Social Media
  facebook          String?     // Facebook profile/page
  instagram         String?     // Instagram handle
  tiktok            String?     // TikTok handle
  youtube           String?     // YouTube channel
  
  // Status
  verified          Boolean     @default(false)
  canChat           Boolean     @default(true)
  lookingForMembers Boolean     @default(false) // Actively recruiting players
  isActive          Boolean     @default(true)  // Account active status
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  clubHistory       RecruiterClubHistory[]
  notes             RecruitmentNote[]
  favorites         Favorite[]
  sentMessages      Message[]   @relation("RecruiterMessages")
  chatRequests      ChatRequest[]
  conversations     Conversation[] @relation("RecruiterConversations")
  
  @@index([clubId])
}

model RecruiterClubHistory {
  id                String      @id @default(cuid())
  recruiterId       String
  recruiter         Recruiter   @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  clubId            String?     // Optional - null if club not in database
  club              Club?       @relation(fields: [clubId], references: [id])
  
  // For clubs not in database
  clubName          String?     // Manual club name entry
  clubLogo          String?     // Base64 or URL to uploaded club logo
  clubCountry       String      @default("Switzerland")
  
  role              String[]    // Head Coach, Assistant, Scout, etc. - can have multiple roles
  genderCoached     Gender?     // Which gender team
  startDate         DateTime
  endDate           DateTime?
  currentClub       Boolean     @default(false)
  
  createdAt         DateTime    @default(now())
  
  @@index([recruiterId])
  @@index([clubId])
}

model ClubManager {
  id                String      @id @default(cuid())
  userId            String      @unique
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  clubId            String
  club              Club        @relation(fields: [clubId], references: [id])
  
  position          String      // e.g., "Head Coach", "Team Manager"
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([clubId])
}

model RecruitmentNote {
  id                String      @id @default(cuid())
  recruiterId       String
  recruiter         Recruiter   @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  playerId          String
  player            Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  note              String      @db.Text
  rating            Int?        // 1-5 stars
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([recruiterId])
  @@index([playerId])
}

model Favorite {
  id                String      @id @default(cuid())
  recruiterId       String
  recruiter         Recruiter   @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  playerId          String
  player            Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime    @default(now())
  
  @@unique([recruiterId, playerId])
  @@index([recruiterId])
  @@index([playerId])
}
// Chat System Models

model ChatRequest {
  id                String              @id @default(cuid())
  
  // Player initiates request to coach
  playerId          String
  player            Player              @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  recruiterId       String
  recruiter         Recruiter           @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  
  message           String              @db.Text  // Initial message from player
  status            ChatRequestStatus   @default(PENDING)
  
  createdAt         DateTime            @default(now())
  respondedAt       DateTime?
  
  @@index([playerId])
  @@index([recruiterId])
  @@index([status])
}

model Conversation {
  id                String      @id @default(cuid())
  
  // Participants
  playerId          String
  player            Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  recruiterId       String
  recruiter         Recruiter   @relation("RecruiterConversations", fields: [recruiterId], references: [id], onDelete: Cascade)
  
  // Status
  isActive          Boolean     @default(true)
  lastMessageAt     DateTime?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  messages          Message[]
  
  @@unique([playerId, recruiterId])
  @@index([playerId])
  @@index([recruiterId])
}

model Message {
  id                String        @id @default(cuid())
  conversationId    String
  conversation      Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  // Sender can be either player or recruiter
  senderId          String
  senderType        UserRole      // PLAYER or RECRUITER
  
  // For player messages
  playerId          String?
  player            Player?       @relation("PlayerMessages", fields: [playerId], references: [id], onDelete: Cascade)
  
  // For recruiter messages
  recruiterId       String?
  recruiter         Recruiter?    @relation("RecruiterMessages", fields: [recruiterId], references: [id], onDelete: Cascade)
  
  content           String        @db.Text
  status            MessageStatus @default(SENT)
  
  createdAt         DateTime      @default(now())
  readAt            DateTime?
  
  @@index([conversationId])
  @@index([playerId])
  @@index([recruiterId])
  @@index([createdAt])
}

model PasswordResetRequest {
  id                Int       @id @default(autoincrement())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  email             String
  token             String    @unique
  newPasswordHash   String
  createdAt         DateTime  @default(now())
  
  @@index([userId])
  @@index([token])
}

// Track unique profile views
model PlayerView {
  id              String    @id @default(cuid())
  playerId        String
  player          Player    @relation("ProfileViews", fields: [playerId], references: [id], onDelete: Cascade)
  viewerUserId    String
  viewerUser      User      @relation("ViewerViews", fields: [viewerUserId], references: [id], onDelete: Cascade)
  viewedAt        DateTime  @default(now())
  
  @@unique([playerId, viewerUserId])
  @@index([playerId])
  @@index([viewerUserId])
}

// Notification system
model Notification {
  id              String           @id @default(cuid())
  userId          String           
  user            User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  
  type            NotificationType
  title           String
  message         String           @db.Text
  
  senderId        String?
  sender          User?            @relation("NotificationSender", fields: [senderId], references: [id], onDelete: SetNull)
  senderName      String?          
  senderImage     String?          
  
  actionUrl       String?
  
  read            Boolean          @default(false)
  emailSent       Boolean          @default(false)
  
  createdAt       DateTime         @default(now())
  readAt          DateTime?
  
  @@index([userId])
  @@index([type])
  @@index([read])
  @@index([createdAt])
}

// Watchlist - for recruiters and hybrid users to track players
model Watchlist {
  id              String    @id @default(cuid())
  playerId        String
  player          Player    @relation("WatchedPlayers", fields: [playerId], references: [id], onDelete: Cascade)
  watcherId       String    // User ID of recruiter or hybrid user
  watcher         User      @relation("WatchlistWatchers", fields: [watcherId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  
  @@unique([playerId, watcherId])
  @@index([playerId])
  @@index([watcherId])
}
